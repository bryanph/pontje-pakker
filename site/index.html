<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pontje Pakker - Departure Times</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 10px;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            width: 100%;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2rem;
            color: #333;
        }

        .current-time {
            text-align: center;
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .stop-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stop-card.reachable {
            border-left: 4px solid #28a745;
        }

        .stop-card.unreachable {
            border-left: 4px solid #dc3545;
        }

        .stop-name {
            font-size: 1.2rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f3f4f6;
        }

        .departure-times {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 8px;
        }

        .departure-time {
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .departure-time.reachable {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .departure-time.unreachable {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            padding: 40px;
        }

        .error {
            background: #fee2e2;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            body {
                padding: 5px;
            }
            
            .container {
                max-width: 100%;
            }
            
            .stops-grid {
                grid-template-columns: 1fr;
            }
            
            .departure-times {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            }
            
            .stop-card {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸš¢ Pontje Pakker</h1>
        </div>

        <div class="current-time" id="currentTime"></div>

        <div id="content">
            <div class="loading">Loading departure times...</div>
        </div>
    </div>

    <script>
        class DepartureBoard {
            constructor() {
                this.data = [];
                // Hard-coded travel times (in minutes)
                this.travelTimes = {
                    'Amsterdam, Distelweg': 8,
                    'Amsterdam, Pontsteiger': 7,
                    'Amsterdam, Zamenhofstraat': 5,
                    'Amsterdam, Buiksloterweg': 9,
                };
                this.init();
            }

            init() {
                this.updateCurrentTime();
                this.loadData();
                setInterval(() => this.updateCurrentTime(), 1000);
                setInterval(() => this.updateDisplay(), 30000); // Update every 30 seconds
            }

            updateCurrentTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('nl-NL', {
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                document.getElementById('currentTime').textContent = `${timeString}`;
            }

            async loadData() {
                try {
                    const timestampDay = new Date().toISOString().split('T')[0];
                    const response = await fetch(`./output.json?t=${timestampDay}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    this.data = await response.json();
                    this.updateDisplay();
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showError('Failed to load departure data. Please check if the output.json file exists.');
                }
            }

            showError(message) {
                const content = document.getElementById('content');
                content.innerHTML = `<div class="error">${message}</div>`;
            }

            updateDisplay() {
                const now = new Date();
                const currentTime = now.getHours() * 60 + now.getMinutes();

                // Group departures by stop
                const stopsData = {};
                this.data.forEach(departure => {
                    if (!stopsData[departure.stop_name]) {
                        stopsData[departure.stop_name] = [];
                    }
                    stopsData[departure.stop_name].push(departure);
                });

                // Sort departures by time and filter future departures
                Object.keys(stopsData).forEach(stopName => {
                    // Filter future departures and sort by time
                    const futureDepartures = stopsData[stopName]
                        .filter(departure => {
                            const [hours, minutes] = departure.departure_time.split(':').map(Number);
                            const departureTime = hours * 60 + minutes;
                            return departureTime > currentTime;
                        })
                        .sort((a, b) => {
                            const [aHours, aMinutes] = a.departure_time.split(':').map(Number);
                            const [bHours, bMinutes] = b.departure_time.split(':').map(Number);
                            return (aHours * 60 + aMinutes) - (bHours * 60 + bMinutes);
                        });
                    
                    // Deduplicate by departure time and take only the first 3 unique times
                    const uniqueDepartures = [];
                    const seenTimes = new Set();
                    
                    for (const departure of futureDepartures) {
                        if (!seenTimes.has(departure.departure_time)) {
                            seenTimes.add(departure.departure_time);
                            uniqueDepartures.push(departure);
                            if (uniqueDepartures.length >= 3) break;
                        }
                    }
                    
                    stopsData[stopName] = uniqueDepartures;
                });

                this.renderStops(stopsData, currentTime);
            }

            renderStops(stopsData, currentTime) {
                const content = document.getElementById('content');
                const stopsGrid = document.createElement('div');
                stopsGrid.className = 'stops-grid';

                // Get stops in the order they appear in this.travelTimes
                const sortedStopNames = Object.keys(this.travelTimes).filter(stopName => 
                    stopsData[stopName] && stopsData[stopName].length > 0
                );

                sortedStopNames.forEach(stopName => {
                    const departures = stopsData[stopName];
                    const travelTime = this.travelTimes[stopName] || 0;
                    
                    // Check if any departure is reachable
                    const hasReachableDeparture = departures.some(departure => {
                        const [hours, minutes] = departure.departure_time.split(':').map(Number);
                        const departureTime = hours * 60 + minutes;
                        return (departureTime - currentTime) >= travelTime;
                    });

                    const stopCard = document.createElement('div');
                    stopCard.className = `stop-card ${hasReachableDeparture ? 'reachable' : 'unreachable'}`;

                    const stopNameDiv = document.createElement('div');
                    stopNameDiv.className = 'stop-name';
                    stopNameDiv.textContent = stopName;
                    stopCard.appendChild(stopNameDiv);

                    const departuresDiv = document.createElement('div');
                    departuresDiv.className = 'departure-times';

                    if (departures.length === 0) {
                        const noDepartures = document.createElement('div');
                        noDepartures.textContent = 'No more departures today';
                        noDepartures.style.color = '#6b7280';
                        noDepartures.style.fontStyle = 'italic';
                        departuresDiv.appendChild(noDepartures);
                    } else {
                        departures.forEach(departure => {
                            const [hours, minutes] = departure.departure_time.split(':').map(Number);
                            const departureTime = hours * 60 + minutes;
                            const timeUntilDeparture = departureTime - currentTime;
                            const isReachable = timeUntilDeparture >= travelTime;

                            const departureDiv = document.createElement('div');
                            departureDiv.className = `departure-time ${isReachable ? 'reachable' : 'unreachable'}`;
                            departureDiv.textContent = departure.departure_time;
                            departuresDiv.appendChild(departureDiv);
                        });
                    }

                    stopCard.appendChild(departuresDiv);
                    stopsGrid.appendChild(stopCard);
                });

                content.innerHTML = '';
                content.appendChild(stopsGrid);
            }
        }

        // Initialize the departure board when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DepartureBoard();
        });
    </script>
</body>
</html>
